<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GIF Background Remover (Animation)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 24px;
        background: #f8fafc;
      }

      canvas {
        border: 1px solid #ccc;
        background: checkerboard;
        margin-top: 12px;
      }

      @keyframes checker {
        from {
          background-position: 0 0;
        }
        to {
          background-position: 16px 16px;
        }
      }

      canvas {
        background:
          linear-gradient(45deg, #eee 25%, transparent 25%),
          linear-gradient(-45deg, #eee 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #eee 75%),
          linear-gradient(-45deg, transparent 75%, #eee 75%);
        background-size: 16px 16px;
        background-position:
          0 0,
          0 8px,
          8px -8px,
          -8px 0px;
      }
    </style>
  </head>
  <body>
    <h2>GIF Background Remover (Full Animation)</h2>

    <input type="file" id="fileInput" accept="image/gif" />

    <canvas id="canvas"></canvas>

    <p>‚ö†Ô∏è Run via <b>http://localhost</b> (Live Server / python http.server)</p>

    <!-- gifuct-js -->
    <script src="https://unpkg.com/gifuct-js@2.1.2/dist/gifuct.min.js"></script>

    <script>
      const input = document.getElementById("fileInput");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      let frames = [];
      let frameIndex = 0;
      let lastTime = 0;

      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => decodeGIF(reader.result);
        reader.readAsArrayBuffer(file);
      });

      function decodeGIF(buffer) {
        const gif = parseGIF(buffer);
        frames = decompressFrames(gif, true);

        const { width, height } = frames[0].dims;
        canvas.width = width;
        canvas.height = height;

        // Remove background on all frames
        frames.forEach((frame) => {
          removeBackground(frame.patch);
        });

        frameIndex = 0;
        lastTime = performance.now();
        requestAnimationFrame(play);
      }

      function play(time) {
        const frame = frames[frameIndex];

        const delay = (frame.delay || 10) * 10; // GIF delay = 1/100 sec

        if (time - lastTime >= delay) {
          const imageData = ctx.createImageData(
            frame.dims.width,
            frame.dims.height,
          );

          imageData.data.set(frame.patch);
          ctx.putImageData(imageData, 0, 0);

          frameIndex = (frameIndex + 1) % frames.length;
          lastTime = time;
        }

        requestAnimationFrame(play);
      }

      function removeBackground(data) {
        // üîë Pick top-left pixel as background color
        const r0 = data[0];
        const g0 = data[1];
        const b0 = data[2];

        const tolerance = 30;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          if (
            Math.abs(r - r0) < tolerance &&
            Math.abs(g - g0) < tolerance &&
            Math.abs(b - b0) < tolerance
          ) {
            data[i + 3] = 0; // transparent
          }
        }
      }
    </script>
  </body>
</html>
